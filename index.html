<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>PDA扫码助手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link rel="icon" href="/favicon.png" type="image/png">
  <!-- <link rel="manifest" href="/manifest.json"> -->
  <meta name="theme-color" content="#6c757d">
  <link crossorigin="anonymous" href="https://lib.baomitu.com/twitter-bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/highlight.js/11.10.0/styles/github-dark.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="/icons/icon-144x144.png" rel="apple-touch-icon" />
  <script>
    window.FEISHU_DEBUG = {
      app_id: 'cli_a8be137e6579500b',
      debug_session: 'NWU0Y2YzYmUtNWYwYy00ZTQwLTk3OTQtZDYwN2E3MGE5N2I4',
      debug_url: 'https://pdabot.jsjs.net/'
    };
  </script>
  <script src="https://lf-package-cn.feishucdn.com/obj/feishu-static/op/fe/devtools_frontend/remote-debug-0.0.1-alpha.6.js"></script>
  <script type="text/javascript" src="https://lf-scm-cn.feishucdn.com/lark/op/h5-js-sdk-1.5.38.js"></script>
  <script>
    // 飞书登录相关功能
    const FEISHU_CONFIG = {
      client_id: 'cli_a8be137e6579500b',
      redirect_uri: 'https://pdabot.jsjs.net/'
    };

    const FEISHU_APP_ID = 'cli_a8be137e6579500b'; // 替换为你的AppID
    function log(msg) {
      const el = document.getElementById('debug-log');
      if (el) el.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg)) + '\n';
    }

    // 检查是否在飞书客户端内
    function isInFeishuClient() {
      const ua = navigator.userAgent;
      const inFeishu = /Lark|Feishu/.test(ua);
      log('userAgent: ' + ua);
      log('isInFeishuClient: ' + inFeishu);
      log('window.tt: ' + (typeof window.tt));
      return inFeishu && typeof window.tt !== 'undefined';
    }

    // 获取飞书预授权码，优先 requestAccess，降级 requestAuthCode
    async function getFeishuPreAuthCode() {
      return new Promise((resolve, reject) => {
        if (window.tt && typeof window.tt.requestAccess === 'function') {
          log('调用 window.tt.requestAccess');
          window.tt.requestAccess({
            appID: FEISHU_APP_ID,
            scopeList: [],
            state: 'myContext',
            success: (res) => {
              log('requestAccess success: ' + JSON.stringify(res));
              resolve(res.code);
            },
            fail: (error) => {
              log('requestAccess fail: ' + JSON.stringify(error));
              if (error.errno === 103) {
                callRequestAuthCode(resolve, reject);
              } else {
                reject(error);
              }
            }
          });
        } else {
          log('window.tt.requestAccess 不存在，降级调用 requestAuthCode');
          callRequestAuthCode(resolve, reject);
        }
      });
    }
    function callRequestAuthCode(resolve, reject) {
      if (window.tt && typeof window.tt.requestAuthCode === 'function') {
        log('调用 window.tt.requestAuthCode');
        window.tt.requestAuthCode({
          appId: FEISHU_APP_ID,
          success: (res) => {
            log('requestAuthCode success: ' + JSON.stringify(res));
            resolve(res.code);
          },
          fail: (error) => {
            log('requestAuthCode fail: ' + JSON.stringify(error));
            reject(error);
          }
        });
      } else {
        log('window.tt.requestAuthCode 不存在，JSAPI不可用');
        reject({ errno: 999, errString: 'JSAPI不可用' });
      }
    }

    // 飞书客户端内免登录
    async function initFeishuAuth() {
      log('initFeishuAuth called');
      if (!/Lark|Feishu/.test(navigator.userAgent) || typeof window.tt === 'undefined') {
        log('非飞书客户端环境，跳过免登录');
        return false;
      }
      try {
        await tt.ready();
        log('tt.ready ok');
        const code = await getFeishuPreAuthCode();
        log('获取到预授权码: ' + code);
        // 调用后端免登录接口
        const response = await fetch('/auth/feishu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        const data = await response.json();
        log('免登录接口返回: ' + JSON.stringify(data));
        if (data.code === 0) {
          localStorage.setItem('isLoggedIn', 'true');
          localStorage.setItem('userId', data.data.open_id);
          localStorage.setItem('userName', data.data.name);
          showMainUI(data.data.name);
          log('免登录成功，已切换主界面');
          return true;
        } else {
          throw new Error(data.msg || '免登录失败');
        }
      } catch (error) {
        log('免登录失败: ' + (error.errString || error.message));
        showToast('免登录失败: ' + (error.errString || error.message), 'danger');
        return false;
      }
    }

    // 初始化二维码登录
    function initQRLogin() {
      if (isInFeishuClient()) {
        console.log('在飞书客户端内，跳过二维码登录初始化');
        return;
      }

      const state = Math.random().toString(36).slice(2);
      const goto = `https://passport.feishu.cn/suite/passport/oauth/authorize?client_id=${FEISHU_CONFIG.client_id}&redirect_uri=${encodeURIComponent(FEISHU_CONFIG.redirect_uri)}&response_type=code&state=${state}`;
      
      var QRLoginObj = QRLogin({
        id: "login_container",
        goto: goto,
        width: "300",
        height: "300"
      });

      var handleMessage = function (event) {
        if (QRLoginObj.matchOrigin(event.origin) && QRLoginObj.matchData(event.data)) {
          var loginTmpCode = event.data.tmp_code;
          window.location.href = `${goto}&tmp_code=${loginTmpCode}`;
        }
      };
      window.addEventListener('message', handleMessage, false);
    }

    // 处理飞书登录回调
    async function handleFeishuCallback(code) {
      try {
        const res = await fetch('https://login-pda.jsjs.net/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            code,
            redirect_uri: FEISHU_CONFIG.redirect_uri
          })
        });
        const data = await res.json();
        if (data.code === 0) {
          // 保存登录状态到 localStorage
          localStorage.setItem('isLoggedIn', 'true');
          localStorage.setItem('userId', data.data.open_id);
          localStorage.setItem('userName', data.data.name);
          // 清除 URL 中的 code 参数
          window.history.replaceState({}, '', '/');
          showToast(`欢迎，${data.data.name}`, 'success');
          // 显示主界面
          showMainUI(data.data.name);
        } else {
          throw new Error(data.msg || '登录失败');
        }
      } catch (error) {
        console.error('登录失败:', error);
        showToast('登录失败: ' + error.message, 'danger');
        showLoginUI();
      }
    }

    // 加载群列表
    async function loadChatList() {
      try {
        const userId = localStorage.getItem('userId');
        if (!userId) {
          console.log('未找到用户ID，跳过加载群列表');
          return;
        }

        const res = await fetch('https://pdabot-worker.jsjs.net/api/chat-list', {
          headers: {
            'Authorization': `Bearer ${userId}`
          }
        });
        const data = await res.json();
        if (data.code === 401) {
          console.log('未授权访问群列表');
          return;
        }
        const chatList = (data.data && data.data.items) ? data.data.items : [];
        const chatSelect = document.getElementById('chatSelect');
        chatSelect.innerHTML = '<option value="">请选择群</option>' + chatList.map(
          c => `<option value="${c.chat_id}">${c.name}</option>`
        ).join('');
      } catch (e) {
        console.error('群列表加载失败:', e);
        showToast('群列表加载失败', 'danger');
      }
    }

    // 显示主界面
    function showMainUI(userName) {
      document.getElementById('loginContainer').classList.add('d-none');
      document.getElementById('mainContainer').classList.remove('d-none');
      
      // 显示用户信息
      const userInfoElement = document.createElement('div');
      userInfoElement.className = 'text-end text-muted small';
      userInfoElement.innerHTML = `当前用户: ${userName}`;
      document.querySelector('h5').appendChild(userInfoElement);

      // 加载群列表
      loadChatList();
    }

    // 显示登录界面
    function showLoginUI() {
      document.getElementById('loginContainer').classList.remove('d-none');
      document.getElementById('mainContainer').classList.add('d-none');
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', async function() {
      log('页面加载完成，开始初始化');
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        log('检测到 code 参数，走 handleFeishuCallback');
        await handleFeishuCallback(code);
      } else {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const userName = localStorage.getItem('userName');
        log('isLoggedIn: ' + isLoggedIn + ', userName: ' + userName);
        if (isLoggedIn && userName) {
          log('已登录，直接显示主界面');
          showMainUI(userName);
        } else {
          log('未登录，尝试免登');
          const autoLoginSuccess = await initFeishuAuth();
          if (!autoLoginSuccess) {
            log('免登失败，显示扫码登录');
            showLoginUI();
            initQRLogin();
          }
        }
      }
    });
  </script>
</head>

<body class="container mb-5">
  <!-- 登录界面 -->
  <div id="loginContainer" class="text-center py-5">
    <div class="card mx-auto" style="max-width: 35rem;">
      <div class="card-header"><i class="bi bi-upc-scan px-2"></i>PDA扫码助手</div>
      <div class="card-body">
        <div id="login_container"></div>
        <p class="card-text">请使用飞书扫码登录</p>
      </div>
    </div>
  </div>

  <!-- 主界面（默认隐藏） -->
  <div id="mainContainer" class="d-none">
    <h5 class="text-center pt-3"><i class="bi bi-upc-scan px-2"></i>PDA扫码助手</h5>
    <div id="toastContainer" class="position-fixed top-50 start-50 translate-middle" style="z-index: 9999;"></div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label fw-bold" for="orderNo">单号：<span id="orderNoDisplay" class="text-primary font-monospace"></span></label>
        <input id="orderNo" type="text" class="form-control" placeholder="请粘贴单号">
      </div>
      <div class="col text-end">
        <label class="form-label fw-bold" for="type">配件类型：</label>
        <select id="type" class="form-select">
          <option selected>请选择</option>
          <option value="CPU">CPU</option>
          <option value="内存">内存</option>
          <option value="硬盘">硬盘</option>
          <option value="光模块">光模块</option>
          <option value="AOC线缆">AOC线缆</option>
          <option value="主板">主板</option>
          <option value="电源">电源</option>
          <option value="网卡">网卡</option>
          <option value="交换机">交换机</option>
        </select>
      </div>
    </div>

    <div id="switchInfoRow" class="row my-3 d-none">
      <div class="col-8 pe-1">
        <label class="form-label" for="switchLocation">交换机位置：</label>
        <input id="switchLocation" type="text" class="form-control" placeholder="">
      </div>
      <div class="col-4 ps-1 text-end">
        <label class="form-label" for="portNo">端口：</label>
        <input id="portNo" type="text" class="form-control" placeholder="">
      </div>
    </div>

    <div id="serverSNRow" class="my-3">
      <label class="form-label font-monospace" for="serverSN"><i class="bi bi-server px-1"></i>服务器SN：</label>
      <input id="serverSN" type="text" class="form-control" placeholder="请扫码">
    </div>

    <div id="brandSection" class="row my-3 d-none">
      <div class="col">
        <label class="form-label text-danger fw-bold" for="newBrand">新件品牌：</label>
        <select id="newBrand" class="form-select">
          <option value="请选择">请选择</option>
        </select>
      </div>
      <div class="col text-end">
        <label class="form-label text-dark fw-bold" for="oldBrand">旧件品牌：</label>
        <select id="oldBrand" class="form-select">
          <option value="请选择">请选择</option>
        </select>
      </div>
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="newSN">
        <span class="text-danger fw-bold">新件SN：</span><small id="countNewSN" class="text-muted">字符数：0</small>
      </label>
      <input id="newSN" type="text" class="form-control" placeholder="">
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="newPN">
        <span class="text-danger fw-bold">新件PN：</span><span id="checkNewPN" class="text-success"></span><small id="countNewPN" class="text-muted">字符数：0</small>
      </label>
      <input id="newPN" list="newPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
      <datalist id="newPnOptions"></datalist>
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="oldSN">
        <span class="text-dark fw-bold">旧件SN：</span><small id="countOldSN" class="text-muted">字符数：0</small>
      </label>
      <input id="oldSN" type="text" class="form-control" placeholder="">
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="oldPN">
        <span class="text-dark fw-bold">旧件PN：</span><span id="checkOldPN" class="text-success"></span><small id="countOldPN" class="text-muted">字符数：0</small>
      </label>
      <input id="oldPN" list="oldPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
      <datalist id="oldPnOptions"></datalist>
    </div>

    <div class="form-group my-3">
      <label class="form-label fw-bold" for="chatSelect">发送到群：</label>
      <select id="chatSelect" class="form-select">
        <option value="">请选择群</option>
      </select>
    </div>

    <div class="d-flex justify-content-between align-items-center my-4 pt-3">
      <button id="resetBtn" class="btn btn-warning" onclick="resetForm()"><i class="bi bi-arrow-counterclockwise pe-1"></i>清空</button>
      <button id="copyBtn" class="btn btn-danger"><i class="bi bi-copy pe-1"></i>复制</button>
      <button class="btn btn-success" onclick="sendApplyNotify()"><i class="bi bi-megaphone-fill pe-1"></i>申领通知</button>
      <button class="btn btn-primary" onclick="sendToFeishu()"><i class="bi bi-send pe-1"></i>替换通知</button>
    </div>
    <pre class="rounded"><code id="preview" class="language-plaintext"></code></pre>
  </div>

  <div id="debug-log" style="white-space:pre;max-height:200px;overflow:auto;background:#eee;font-size:12px;"></div>

  <script crossorigin="anonymous" src="https://lib.baomitu.com/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script crossorigin="anonymous" src="https://lib.baomitu.com/highlight.js/11.10.0/highlight.min.js"></script>
  <script src="https://lf-package-cn.feishucdn.com/obj/feishu-static/lark/passport/qrcode/LarkSSOSDKWebQRCode-1.0.3.js"></script>
  <script>
    (async function () {
      try {
        const res = await fetch('https://pn.jsjs.net/pn', { cache: 'force-cache' });
        window.partsData = await res.json();
        window.partsDataReady = true;
        window.dispatchEvent(new Event('partsDataLoaded'));
      } catch (error) {
        console.error('加载配件数据失败:', error);
      }
    })();
  </script>
  <script src="pda.js"></script>
</body>

</html>
