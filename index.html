<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>PDA扫码助手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link rel="icon" href="/favicon.png" type="image/png">
  <!-- <link rel="manifest" href="/manifest.json"> -->
  <meta name="theme-color" content="#6c757d">
  <link crossorigin="anonymous" href="https://lib.baomitu.com/twitter-bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/highlight.js/11.10.0/styles/github-dark.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="/icons/icon-144x144.png" rel="apple-touch-icon" />
</head>

<body class="container mb-5">
  <!-- 登录界面 -->
  <div id="loginUI" class="text-center py-5">
    <div class="card mx-auto" style="max-width: 35rem;">
      <div class="card-header"><i class="bi bi-upc-scan px-2"></i>PDA扫码助手</div>
      <div class="card-body">
        <div id="login_container"></div>
        <p class="card-text">请使用飞书扫码登录</p>
      </div>
    </div>
  </div>

  <!-- 主界面（默认隐藏） -->
  <div id="mainUI" class="d-none">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h5 class="mb-0"><i class="bi bi-upc-scan px-2"></i>PDA扫码助手</h5>
            <div class="d-flex align-items-center">
              <img id="userAvatar" src="https://s3-imfile.feishucdn.com/static-resource/v1/v2_7b2b3c3c-3c3c-3c3c-3c3c-3c3c3c3c3c3c~?image_size=72x72&cut_type=&quality=&format=image&sticker_format=.webp" 
                   alt="用户头像" 
                   class="rounded-circle" 
                   style="width: 32px; height: 32px; object-fit: cover; border: 2px solid #e9ecef; cursor: pointer;"
                   data-bs-toggle="tooltip"
                   data-bs-placement="bottom"
                   title="未登录">
            </div>
          </div>
        </div>
      </div>
      <div id="toastContainer" class="position-fixed top-50 start-50 translate-middle" style="z-index: 9999;"></div>

      <div class="row mb-3">
        <div class="col">
          <label class="form-label fw-bold" for="orderNo">单号：<span id="orderNoDisplay" class="text-primary font-monospace"></span></label>
          <input id="orderNo" type="text" class="form-control" placeholder="请粘贴单号">
        </div>
        <div class="col text-end">
          <label class="form-label fw-bold" for="type">配件类型：</label>
          <select id="type" class="form-select">
            <option selected>请选择</option>
            <option value="CPU">CPU</option>
            <option value="内存">内存</option>
            <option value="硬盘">硬盘</option>
            <option value="光模块">光模块</option>
            <option value="AOC线缆">AOC线缆</option>
            <option value="主板">主板</option>
            <option value="电源">电源</option>
            <option value="网卡">网卡</option>
            <option value="交换机">交换机</option>
          </select>
        </div>
      </div>

      <div id="switchInfoRow" class="row my-3 d-none">
        <div class="col-8 pe-1">
          <label class="form-label" for="switchLocation">交换机位置：</label>
          <input id="switchLocation" type="text" class="form-control" placeholder="">
        </div>
        <div class="col-4 ps-1 text-end">
          <label class="form-label" for="portNo">端口：</label>
          <input id="portNo" type="text" class="form-control" placeholder="">
        </div>
      </div>

      <div id="serverSNRow" class="my-3">
        <label class="form-label font-monospace" for="serverSN"><i class="bi bi-server px-1"></i>服务器SN：</label>
        <input id="serverSN" type="text" class="form-control" placeholder="请扫码">
      </div>

      <div id="brandSection" class="row my-3 d-none">
        <div class="col">
          <label class="form-label text-danger fw-bold" for="newBrand">新件品牌：</label>
          <select id="newBrand" class="form-select">
            <option value="请选择">请选择</option>
          </select>
        </div>
        <div class="col text-end">
          <label class="form-label text-dark fw-bold" for="oldBrand">旧件品牌：</label>
          <select id="oldBrand" class="form-select">
            <option value="请选择">请选择</option>
          </select>
        </div>
      </div>

      <div class="form-group my-3">
        <label class="form-label d-flex justify-content-between" for="newSN">
          <span class="text-danger fw-bold">新件SN：</span><small id="countNewSN" class="text-muted">字符数：0</small>
        </label>
        <input id="newSN" type="text" class="form-control" placeholder="">
      </div>

      <div class="form-group my-3">
        <label class="form-label d-flex justify-content-between" for="newPN">
          <span class="text-danger fw-bold">新件PN：</span><span id="checkNewPN" class="text-success"></span><small id="countNewPN" class="text-muted">字符数：0</small>
        </label>
        <input id="newPN" list="newPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
        <datalist id="newPnOptions"></datalist>
      </div>

      <div class="form-group my-3">
        <label class="form-label d-flex justify-content-between" for="oldSN">
          <span class="text-dark fw-bold">旧件SN：</span><small id="countOldSN" class="text-muted">字符数：0</small>
        </label>
        <input id="oldSN" type="text" class="form-control" placeholder="">
      </div>

      <div class="form-group my-3">
        <label class="form-label d-flex justify-content-between" for="oldPN">
          <span class="text-dark fw-bold">旧件PN：</span><span id="checkOldPN" class="text-success"></span><small id="countOldPN" class="text-muted">字符数：0</small>
        </label>
        <input id="oldPN" list="oldPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
        <datalist id="oldPnOptions"></datalist>
      </div>

      <div class="form-group my-3">
        <label class="form-label fw-bold" for="chatSelect">发送到群：</label>
        <select id="chatSelect" class="form-select">
          <option value="">请选择群</option>
        </select>
      </div>

      <div class="d-flex justify-content-between align-items-center my-4 pt-3">
        <button id="resetBtn" class="btn btn-warning" onclick="resetForm()"><i class="bi bi-arrow-counterclockwise pe-1"></i>清空</button>
        <button id="copyBtn" class="btn btn-danger"><i class="bi bi-copy pe-1"></i>复制</button>
        <button class="btn btn-success" onclick="sendApplyNotify()"><i class="bi bi-megaphone-fill pe-1"></i>申领通知</button>
        <button class="btn btn-primary" onclick="sendToFeishu()"><i class="bi bi-send pe-1"></i>替换通知</button>
      </div>
      <!-- 预览区域（兼容移动端） -->
      <pre class="rounded"><code id="preview" class="language-plaintext"></code></pre>
    </div>
  </div>

  <!-- 脚本放在底部 -->
  <script type="text/javascript" src="https://lf-scm-cn.feishucdn.com/lark/op/h5-js-sdk-1.5.38.js"></script>
  <script crossorigin="anonymous" src="https://lib.baomitu.com/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script crossorigin="anonymous" src="https://lib.baomitu.com/highlight.js/11.10.0/highlight.min.js"></script>
  <script src="https://lf-package-cn.feishucdn.com/obj/feishu-static/lark/passport/qrcode/LarkSSOSDKWebQRCode-1.0.3.js"></script>
  
  <script>
    // 飞书应用配置
    const FEISHU_CONFIG = {
      client_id: 'cli_a8b10d009ef8d00c',
      redirect_uri: 'https://pdabot.jsjs.net/'
    };

    // 飞书登录状态管理
    const FeishuAuth = {
      // 检查是否在飞书客户端内
      isInClient: () => /Lark|Feishu/.test(navigator.userAgent) && typeof window.tt !== 'undefined',

      // 获取预授权码
      getPreAuthCode: async () => {
        if (!FeishuAuth.isInClient()) {
          throw new Error('非飞书客户端环境');
        }

        try {
          if (window.tt?.requestAccess) {
            return await new Promise((resolve, reject) => {
              window.tt.requestAccess({
                appID: FEISHU_CONFIG.client_id,
                scopeList: [],
                state: 'myContext',
                success: (res) => resolve(res.code),
                fail: (error) => {
                  if (error.errno === 103) {
                    FeishuAuth.requestAuthCode(resolve, reject);
                  } else {
                    reject(error);
                  }
                }
              });
            });
          } else {
            return await FeishuAuth.requestAuthCode();
          }
        } catch (error) {
          console.error('获取预授权码失败:', error);
          throw error;
        }
      },

      // 降级获取授权码
      requestAuthCode: async () => {
        if (!window.tt?.requestAuthCode) {
          throw new Error('JSAPI不可用');
        }

        return new Promise((resolve, reject) => {
          window.tt.requestAuthCode({
            appId: FEISHU_CONFIG.client_id,
            success: (res) => resolve(res.code),
            fail: (error) => reject(error)
          });
        });
      },

      // 处理登录回调
      handleLoginCallback: async ({ code, type }) => {
        try {
          const url = type === 'scan' 
            ? 'https://pdabot.jsjs.net/auth/scan'
            : 'https://pdabot.jsjs.net/auth/feishu';

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code })
          });

          const data = await response.json();
          if (data.code !== 0) {
            throw new Error(data.msg || '登录失败');
          }

          // 存储用户信息
          FeishuAuth.saveUserInfo(data.data);
          return data.data;
        } catch (error) {
          console.error('登录回调处理失败:', error);
          throw error;
        }
      },

      // 保存用户信息
      saveUserInfo: (data) => {
        const userInfo = {
          access_token: data.access_token,
          refresh_token: data.refresh_token,
          expireTime: data.expireTime,
          tokenInfo: data.tokenInfo
        };

        // 存储 token 信息
        localStorage.setItem('feishu_token', JSON.stringify(userInfo));
        
        // 存储用户基本信息
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userId', data.user_id);
        localStorage.setItem('userName', data.name);
        localStorage.setItem('userAvatar', data.avatar_url);

        // 更新当前用户信息
        window.currentUser = {
          id: data.user_id,
          name: data.name,
          avatar: data.avatar_url
        };
      },

      // 初始化二维码登录
      initQRLogin: () => {
        if (FeishuAuth.isInClient()) return;

        const state = Math.random().toString(36).slice(2);
        const goto = `https://passport.feishu.cn/suite/passport/oauth/authorize?` + 
          new URLSearchParams({
            client_id: FEISHU_CONFIG.client_id,
            redirect_uri: encodeURIComponent(FEISHU_CONFIG.redirect_uri),
            response_type: 'code',
            state
          }).toString();

        const QRLoginObj = QRLogin({
          id: "login_container",
          goto,
          width: "300",
          height: "300"
        });

        // 处理消息回调
        const handleMessage = (event) => {
          if (QRLoginObj.matchOrigin(event.origin) && QRLoginObj.matchData(event.data)) {
            window.location.href = `${goto}&tmp_code=${event.data.tmp_code}`;
          }
        };

        window.addEventListener('message', handleMessage, false);
      },

      // 客户端内免登录
      initClientAuth: async () => {
        if (!FeishuAuth.isInClient()) return false;

        try {
          const code = await new Promise((resolve, reject) => {
            window.tt.requestAccess({
              appID: FEISHU_CONFIG.client_id,
              scopeList: [],
              state: 'myContext',
              redirect_uri: FEISHU_CONFIG.redirect_uri,
              success: (res) => resolve(res.code),
              fail: (error) => {
                if (error.errno === 103) {
                  window.tt.requestAuthCode({
                    appId: FEISHU_CONFIG.client_id,
                    redirect_uri: FEISHU_CONFIG.redirect_uri,
                    success: (res) => resolve(res.code),
                    fail: (error) => reject(error)
                  });
                } else {
                  reject(error);
                }
              }
            });
          });

          const data = await FeishuAuth.handleLoginCallback({ code, type: 'feishu' });
          return true;
        } catch (error) {
          console.error('客户端免登录失败:', error);
          return false;
        }
      },

      // 加载群列表
      loadChatList: async () => {
        try {
          const tokenInfo = JSON.parse(localStorage.getItem('feishu_token') || '{}');
          if (!tokenInfo.access_token) {
            showToast('未登录，无法获取群列表', 'warning');
            return;
          }

          const res = await fetch('https://pdabot.jsjs.net/api/chat-list', {
            headers: {
              'Authorization': `Bearer ${tokenInfo.access_token}`
            }
          });
          const data = await res.json();
          if (data.code === 401) {
            // 如果 token 过期，尝试刷新
            if (tokenInfo.refresh_token) {
              try {
                const refreshRes = await fetch('https://pdabot.jsjs.net/auth/refresh', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    user_id: localStorage.getItem('userId'),
                    refresh_token: tokenInfo.refresh_token
                  })
                });
                const refreshData = await refreshRes.json();
                if (refreshData.code === 0) {
                  // 更新 token 信息
                  localStorage.setItem('feishu_token', JSON.stringify(refreshData.data));
                  // 重试加载群列表
                  return FeishuAuth.loadChatList();
                }
              } catch (e) {
                console.error('刷新 token 失败:', e);
              }
            }
            showToast('未授权访问群列表', 'danger');
            return;
          }
          if (data.code === 0 && data.data && data.data.items) {
            const chatSelect = document.getElementById('chatSelect');
            if (chatSelect) {
              chatSelect.innerHTML = '<option value="">请选择要发送的群</option>' + 
                data.data.items.map(chat => 
                  `<option value="${chat.chat_id}">${chat.name}</option>`
                ).join('');
            }
          } else {
            showToast('群列表数据格式错误', 'warning');
          }
        } catch (e) {
          console.error('加载群列表失败:', e);
          showToast('群列表加载失败', 'danger');
        }
      }
    };

    // 添加提示框函数
    const showToast = (msg, type = "primary", delay = 5000) => {
      const container = document.getElementById("toastContainer");
      if (!container) {
        console.error('未找到提示框容器');
        return;
      }

      const toast = document.createElement("div");
      toast.className = `toast text-bg-${type} border-0`;
      toast.setAttribute("role", "alert");
      toast.setAttribute("aria-live", "assertive");
      toast.setAttribute("aria-atomic", "true");
      toast.innerHTML = `<div class="toast-body">${msg}</div>`;
      container.appendChild(toast);

      const bsToast = new bootstrap.Toast(toast, {
        animation: true,
        autohide: true,
        delay: delay
      });
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    };

    // 检查token有效性
    const isTokenValid = () => {
      const tokenInfo = JSON.parse(localStorage.getItem('feishu_token') || '{}');
      // 假设有 expireTime 字段，单位为毫秒时间戳
      return tokenInfo.access_token && tokenInfo.expireTime && Date.now() < tokenInfo.expireTime;
    };

    // 显示主界面和头像
    const showMainUI = () => {
      document.getElementById('loginUI').style.display = 'none';
      document.getElementById('mainUI').classList.remove('d-none');
      // 显示头像
      const avatarUrl = localStorage.getItem('userAvatar');
      const userName = localStorage.getItem('userName');
      showUserAvatar(avatarUrl, userName);
    };

    // 显示扫码界面
    const showLoginUI = () => {
      document.getElementById('loginUI').style.display = 'block';
      document.getElementById('mainUI').classList.add('d-none');
      // 不显示头像
      showUserAvatar();
    };

    // 头像渲染函数
    const showUserAvatar = (avatarUrl, userName) => {
      const box = document.getElementById('userAvatarBox');
      if (!box) return;
      box.innerHTML = '';
      if (avatarUrl) {
        const img = document.createElement('img');
        img.src = avatarUrl;
        img.alt = '用户头像';
        img.className = 'rounded-circle';
        img.style = 'width: 32px; height: 32px; object-fit: cover; border: 2px solid #e9ecef; cursor: pointer;';
        img.setAttribute('title', userName || '');
        box.appendChild(img);
      }
      // 否则什么都不显示
    };

    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
      if (isTokenValid()) {
        showMainUI();
      } else {
        // 清除本地token和用户信息
        localStorage.removeItem('feishu_token');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('userId');
        localStorage.removeItem('userName');
        localStorage.removeItem('userAvatar');
        showLoginUI();
      }
    });

    // 加载配件数据
    (async () => {
      try {
        const res = await fetch('https://pn.jsjs.net/pn', { cache: 'force-cache' });
        window.partsData = await res.json();
        window.partsDataReady = true;
        window.dispatchEvent(new Event('partsDataLoaded'));
      } catch (error) {
        console.error('加载配件数据失败:', error);
      }
    })();
  </script>
  <script src="pda.js"></script>
</body>

</html>
