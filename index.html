<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>PDA扫码助手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link rel="icon" href="/favicon.png" type="image/png">
  <!-- <link rel="manifest" href="/manifest.json"> -->
  <meta name="theme-color" content="#6c757d">
  <link crossorigin="anonymous" href="https://lib.baomitu.com/twitter-bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/highlight.js/11.10.0/styles/github-dark.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="/icons/icon-144x144.png" rel="apple-touch-icon" />
  <script>
    window.FEISHU_DEBUG = {
      app_id: 'cli_a8be137e6579500b',
      debug_session: 'NWU0Y2YzYmUtNWYwYy00ZTQwLTk3OTQtZDYwN2E3MGE5N2I4',
      debug_url: 'https://pdabot.jsjs.net/'
    };
  </script>
  <script src="https://lf-package-cn.feishucdn.com/obj/feishu-static/op/fe/devtools_frontend/remote-debug-0.0.1-alpha.6.js"></script>
  <script src="https://s3.pstatp.com/ee/lark/js/open-js-sdk-1.5.23.js"></script>
</head>

<body class="container mb-5">
  <!-- 登录界面 -->
  <div id="loginContainer" class="text-center py-5">
    <h4 class="card-header"><i class="bi bi-upc-scan px-2"></i>PDA扫码助手</h4>
    <div class="card mx-auto">
      <div class="card-body">
        <div id="login_container"></div>
        <p class="card-text">请使用飞书扫码登录</p>
      </div>
    </div>
  </div>

  <!-- 主界面（默认隐藏） -->
  <div id="mainContainer" class="d-none">
    <h5 class="text-center pt-3"><i class="bi bi-upc-scan px-2"></i>PDA扫码助手</h5>
    <div id="toastContainer" class="position-fixed top-50 start-50 translate-middle" style="z-index: 9999;"></div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label fw-bold" for="orderNo">单号：<span id="orderNoDisplay" class="text-primary font-monospace"></span></label>
        <input id="orderNo" type="text" class="form-control" placeholder="请粘贴单号">
      </div>
      <div class="col text-end">
        <label class="form-label fw-bold" for="type">配件类型：</label>
        <select id="type" class="form-select">
          <option selected>请选择</option>
          <option value="CPU">CPU</option>
          <option value="内存">内存</option>
          <option value="硬盘">硬盘</option>
          <option value="光模块">光模块</option>
          <option value="AOC线缆">AOC线缆</option>
          <option value="主板">主板</option>
          <option value="电源">电源</option>
          <option value="网卡">网卡</option>
          <option value="交换机">交换机</option>
        </select>
      </div>
    </div>

    <div id="switchInfoRow" class="row my-3 d-none">
      <div class="col-8 pe-1">
        <label class="form-label" for="switchLocation">交换机位置：</label>
        <input id="switchLocation" type="text" class="form-control" placeholder="">
      </div>
      <div class="col-4 ps-1 text-end">
        <label class="form-label" for="portNo">端口：</label>
        <input id="portNo" type="text" class="form-control" placeholder="">
      </div>
    </div>

    <div id="serverSNRow" class="my-3">
      <label class="form-label font-monospace" for="serverSN"><i class="bi bi-server px-1"></i>服务器SN：</label>
      <input id="serverSN" type="text" class="form-control" placeholder="请扫码">
    </div>

    <div id="brandSection" class="row my-3 d-none">
      <div class="col">
        <label class="form-label text-danger fw-bold" for="newBrand">新件品牌：</label>
        <select id="newBrand" class="form-select">
          <option value="请选择">请选择</option>
        </select>
      </div>
      <div class="col text-end">
        <label class="form-label text-dark fw-bold" for="oldBrand">旧件品牌：</label>
        <select id="oldBrand" class="form-select">
          <option value="请选择">请选择</option>
        </select>
      </div>
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="newSN">
        <span class="text-danger fw-bold">新件SN：</span><small id="countNewSN" class="text-muted">字符数：0</small>
      </label>
      <input id="newSN" type="text" class="form-control" placeholder="">
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="newPN">
        <span class="text-danger fw-bold">新件PN：</span><span id="checkNewPN" class="text-success"></span><small id="countNewPN" class="text-muted">字符数：0</small>
      </label>
      <input id="newPN" list="newPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
      <datalist id="newPnOptions"></datalist>
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="oldSN">
        <span class="text-dark fw-bold">旧件SN：</span><small id="countOldSN" class="text-muted">字符数：0</small>
      </label>
      <input id="oldSN" type="text" class="form-control" placeholder="">
    </div>

    <div class="form-group my-3">
      <label class="form-label d-flex justify-content-between" for="oldPN">
        <span class="text-dark fw-bold">旧件PN：</span><span id="checkOldPN" class="text-success"></span><small id="countOldPN" class="text-muted">字符数：0</small>
      </label>
      <input id="oldPN" list="oldPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
      <datalist id="oldPnOptions"></datalist>
    </div>

    <div class="form-group my-3">
      <label class="form-label fw-bold" for="chatSelect">发送到群：</label>
      <select id="chatSelect" class="form-select">
        <option value="">请选择群</option>
      </select>
    </div>

    <div class="d-flex justify-content-between align-items-center my-4 pt-3">
      <button id="resetBtn" class="btn btn-warning" onclick="resetForm()"><i class="bi bi-arrow-counterclockwise pe-1"></i>清空</button>
      <button id="copyBtn" class="btn btn-danger"><i class="bi bi-copy pe-1"></i>复制</button>
      <button class="btn btn-success" onclick="sendApplyNotify()"><i class="bi bi-megaphone-fill pe-1"></i>申领通知</button>
      <button class="btn btn-primary" onclick="sendToFeishu()"><i class="bi bi-send pe-1"></i>替换通知</button>
    </div>
    <pre class="rounded"><code id="preview" class="language-plaintext"></code></pre>
  </div>

  <script crossorigin="anonymous" src="https://lib.baomitu.com/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script crossorigin="anonymous" src="https://lib.baomitu.com/highlight.js/11.10.0/highlight.min.js"></script>
  <script src="https://lf-package-cn.feishucdn.com/obj/feishu-static/lark/passport/qrcode/LarkSSOSDKWebQRCode-1.0.3.js"></script>
  <script>
    // 自动处理 code 并切换主界面
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        // 显示加载状态
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          loginContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div><p class="mt-3">正在处理登录...</p></div>';
        }
        
        // 调用后端 /auth 换用户信息
        fetch('https://login-pda.jsjs.net/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: code,
            redirect_uri: 'https://pdabot.jsjs.net/'
          })
        })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (data.code === 0) {
            // 登录成功，保存用户信息
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userId', data.data.open_id);
            localStorage.setItem('userName', data.data.name);
            // 清除 URL 中的 code 参数
            window.history.replaceState({}, '', '/');
            // 切换到主界面
            document.getElementById('loginContainer').classList.add('d-none');
            document.getElementById('mainContainer').classList.remove('d-none');
          } else {
            throw new Error(data.msg || '未知错误');
          }
        })
        .catch(error => {
          console.error('登录失败:', error);
          // 恢复登录界面
          if (loginContainer) {
            loginContainer.innerHTML = `
              <h4 class="mb-4"><i class="bi bi-upc-scan px-2"></i>PDA扫码助手</h4>
              <div class="card mx-auto" style="max-width: 400px;">
                <div class="card-body">
                  <h5 class="card-title mb-4">请使用飞书扫码登录</h5>
                  <div id="login_container"></div>
                </div>
              </div>
            `;
            // 重新初始化登录组件
            initLoginComponent();
          }
          alert('登录失败：' + error.message);
        });
      } else {
        // 没有 code，显示二维码界面
        document.getElementById('loginContainer').classList.remove('d-none');
        document.getElementById('mainContainer').classList.add('d-none');
      }
    });

    // 初始化登录组件
    function initLoginComponent() {
      var client_id = 'cli_a8be137e6579500b';
      var redirect_uri = encodeURIComponent('https://pdabot.jsjs.net/');
      var state = Math.random().toString(36).slice(2);
      var goto = `https://passport.feishu.cn/suite/passport/oauth/authorize?client_id=${client_id}&redirect_uri=${redirect_uri}&response_type=code&state=${state}`;
      var QRLoginObj = QRLogin({
        id: "login_container",
        goto: goto,
        width: "300",
        height: "300"
      });
      var handleMessage = function (event) {
        if (QRLoginObj.matchOrigin(event.origin) && QRLoginObj.matchData(event.data)) {
          var loginTmpCode = event.data.tmp_code;
          window.location.href = `${goto}&tmp_code=${loginTmpCode}`;
        }
      };
      window.addEventListener('message', handleMessage, false);
    }

    // 初始化登录组件
    initLoginComponent();

    async function loadChatList() {
      try {
        const res = await fetch('https://pdabot-worker.jsjs.net/api/chat-list');
        const data = await res.json();
        const chatList = (data.data && data.data.items) ? data.data.items : [];
        const chatSelect = document.getElementById('chatSelect');
        chatSelect.innerHTML = '<option value="">请选择群</option>' + chatList.map(
          c => `<option value="${c.chat_id}">${c.name}</option>`
        ).join('');
      } catch (e) {
        showToast('群列表加载失败', 'danger');
      }
    }
    document.addEventListener('DOMContentLoaded', loadChatList);
  </script>
  <script src="pda.js"></script>
</body>

</html> 
